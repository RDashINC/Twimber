<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Twimber</title>

    <!-- Bootstrap core CSS -->
    <link href="engine/public/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="engine/public/css/cover.css" rel="stylesheet">
	
	<script type="text/javascript">
		function doLogin() {
			var user = document.getElementById("login-username").value;
			doLoadThing("login-button");
			if(userExists(user)===true) {
				global.twitter_user = user;
				// Init Application.
				window.location.replace("login.html#users");
				$(document).ready(function() {
					getUsersImages("#show_users", true);
				});
			} else {
				requestPin(user);
			}
		}
		function doLoginNoInput(user) {
			doLoadThing("main-disp");
			if(userExists(user)===true) {
				global.twitter_user = user;
				window.location.reload();
				window.location.replace("login.html#users");
			} else {
				requestPin(user);
			}
		}
	</script>
	<script src="engine/public/js/aes.js" type="text/javascript"></script>
	<script src="engine/public/js/config.js" type="text/javascript"></script>
	<script src="engine/public/js/jquery-2.1.1.min.js" type="text/javascript"></script>
	<script src="engine/public/js/jquery.hotkeys.js" type="text/javascript"></script>
	<script src="engine/public/js/bootstrap.js" type="text/javascript"></script>
	<script src="engine/public/js/jquery.linkify.min.js" type="text/javascript"></script>
	<script src="engine/public/js/jquery.backstretch.js" type="text/javascript"></script>
	<script src="engine/public/js/functions.js" type="text/javascript"></script>
	<script src="engine/public/js/screenshot.js" type="text/javascript"></script>
	<script src="engine/public/js/jsOAuth-1.1.js" type="text/javascript"></script>
	<script src="engine/public/js/twitter.js" type="text/javascript"></script>
	<script type="text/javascript">
		function loadContent(hash) {
			console.log("[login.html] (): Hash Changed -- Changing Content accordingly.");
			if(hash !== "" ) {
				if(hash == "#contact") {
					document.getElementById("nav-menu").innerHTML="<li><a href='#'>Home</a></li><li><a href='#about'>About</a></li><li class='active'><a href='#contact'>Contact</a></li>";
					document.getElementById("main-disp").innerHTML="<p class='lead'>&nbsp;</p><h1 class='cover-heading'>UC</h1><p class='lead'>&nbsp;</p>";
				} else if (hash == "#about") {
					document.getElementById("nav-menu").innerHTML="<li><a href='#'>Home</a></li><li class='active'><a href='#about'>About</a></li><li><a href='#contact'>Contact</a></li>";
					document.getElementById("main-disp").innerHTML="<p class='lead'>&nbsp;</p><h1 class='cover-heading'>UC</h1><p class='lead'>&nbsp;</p>";
				} else if(hash == "#users") {
					if(typeof(global.pwd)==='undefined') {
						console.log("global.pwd is not defined. Returning.");
						window.location("load.html");
					}
					/** Reload Config: TODO MAKE FUNCTION **/
					eval(getConfigFile());
					
					var Twit = require('twitter');
					var T = new Twit(window.config);
					
					/** Check Creds **/
					T.get('users/show', { screen_name: window.config.screen_name } , function(err, data, response) {
						if(err) {
							parseTwitterError(err);
						}
						console.log("[twitter] /loadContent/ => [user/show]: Looked up user: "+data.screen_name);
						console.log(data);
						if (data.status.source == "web") {
							var source="<a href='http://twitter.com/'>web</a>"
						} else {
							var source=data.status.source;
						}
						document.getElementById("nav-menu").innerHTML="<li><a href='#'>Home</a></li><li><a href='#about'>About</a></li><li><a href='#contact'>Contact</a></li>";
						document.getElementById("main-disp").innerHTML="<p class='lead'>&nbsp;</p><h1 class='cover-heading'><img src='"+data.profile_image_url.replace('normal', 'bigger')+"' alt='"+data.screen_name+"'></h1><p class='lead'>["+data.name+"] - "+processTweetLinks("@"+data.screen_name)+"</p><p id='status' class='lead'>\""+processTweetLinks(data.status.text)+"\"</p><p class='lead'>from "+source+"</p><p class='lead'><button id='mainLbutton' class='btn btn-default' type='button' focus onclick='loginAsMain();'>Login as @"+data.screen_name+"</button>&nbsp;<button class='btn btn-default' type='button' focus onclick='window.location=\"login.html#adduser\"'>Add User</button>&nbsp;<button class='btn btn-default' type='button' focus onclick='getUsersImages(\"#show_users\");'>Get Users</button><p class='lead'><div id='show_users'></div></p>";
					});
				} else if(hash == "#master") {
					document.getElementById("main-disp").innerHTML="<p class='lead'>&nbsp;</p><h1 class='cover-heading'>Twimber</h1><p class='lead'><input  style='color:black;' id='pwd' type='password' placeholder='Master Password' required focus></p><p class='lead'><button class='btn btn-default' id='masterbutton' type='button' onclick='doAuthPage();'>Login</button></p><p class='lead'>&nbsp;</p>";
					$('#pwd').keypress(function(e) {
						if(e.which == 13) {
							doAuthPage();
						}
					});
				} else if (hash =="#adduser") {
					document.getElementById("main-disp").innerHTML="<p class='lead'>&nbsp;</p><h1 class='cover-heading'>Add User</h1><p class='lead'><input style='color:black' type='text' id='login-username' placeholder='Username' required></p><p class='lead'><button id='login-button' onclick='doLogin();' class='btn btn-default' type='button' focus>Send</button></p><p class='lead'>&nbsp;</p>";
					$('#login-username').keypress(function(e) {
						if(e.which == 13) {
							doLogin();
						}
					});
				} else {
					if(typeof(global.pwd)==='undefined') {
						document.getElementById("main-disp").innerHTML="<p class='lead'>&nbsp;</p><h1 class='cover-heading'>Setup</h1><p class='lead'><input  style='color:black;' id='pin' type='text' placeholder='PIN' required></p><p class='lead'><input  style='color:black;' id='pwd' type='password' placeholder='Master Password' required></p><p class='lead'><button class='btn btn-default' id='pinbutton' type='button' onclick='auth();'>Submit</button></p><p class='lead'>&nbsp;</p>";
					} else {
						document.getElementById("main-disp").innerHTML="<p class='lead'>&nbsp;</p><h1 class='cover-heading'>Setup</h1><p class='lead'><input  style='color:black;' id='pin' type='text' placeholder='PIN' required></p><p class='lead'><input  style='color:black;' id='pwd' type='password' value='"+global.pwd+"' disabled required></p><p class='lead'><button class='btn btn-default' id='pinbutton' type='button' onclick='auth();'>Submit</button></p><p class='lead'>&nbsp;</p>";
					}
					$('#pwd').keypress(function(e) {
						if(e.which == 13) {
							auth();
						}
					});
				}
			} else {
				eval(getConfigFile());
				if(typeof(window.config.screen_name)==='undefined') {
					document.getElementById("nav-menu").innerHTML="<li class='active'><a href='#'>Home</a></li><li><a href='#about'>About</a></li><li><a href='#contact'>Contact</a></li>";
					document.getElementById("main-disp").innerHTML="<p class='lead'>&nbsp;</p><h1 class='cover-heading'>Login</h1><p class='lead'><input style='color:black' type='text' id='login-username' placeholder='Username' required></p><p class='lead'><button id='login-button' onclick='doLogin();' class='btn btn-default' type='button' focus>Send</button></p><p class='lead'>&nbsp;</p>";
					$('#login-username').keypress(function(e) {
						if(e.which == 13) {
							doLogin();
						}
					});
				} else {
					window.location.replace('login.html#users');
				}
			}
		}
		
		// Handles page display.
		// Initial Load.
		$(document).ready(function() { loadContent(location.hash); });
		$(window).on('hashchange', function () {
			loadContent(location.hash);
		});
		
		$(document).ready(function() {
			$("html").backstretch([
				"engine/public/img/bg.jpg",
				"engine/public/img/bg2.jpg",
				"engine/public/img/bg3.jpg",
				"engine/public/img/bg4.jpg"
			], {duration: 7500, fade: 900});
		});
	</script>
  </head>

  <body>

    <div class="site-wrapper">

      <div class="site-wrapper-inner">

        <div class="cover-container">

          <div class="masthead clearfix">
            <div class="inner">
              <h3 class="masthead-brand">Twimber</h3>
              <ul id="nav-menu" class="nav masthead-nav">
              </ul>
            </div>
          </div>

          <div style="word-wrap:break-word;-webkit-border-top-left-radius: 15px;-webkit-border-bottom-left-radius: 15px; -webkit-border-top-right-radius: 15px;-webkit-border-bottom-right-radius: 15px;display:block; background: rgba(64, 64, 64, 0.8);" id='main-disp' class='inner cover'>
			<img src='engine/public/img/page_load.gif'>
		  </div>

          <div class="mastfoot">
            <div style="display:inline;-webkit-border-top-left-radius: 15px;-webkit-border-bottom-left-radius: 15px; -webkit-border-top-right-radius: 15px;-webkit-border-bottom-right-radius: 15px;background: rgba(64, 64, 64, 0.8);" class="inner">
              <p style='display:inline;-webkit-border-top-left-radius: 15px;-webkit-border-bottom-left-radius: 15px; -webkit-border-top-right-radius: 15px;-webkit-border-bottom-right-radius: 15px;background: rgba(64, 64, 64, 0.8);'>Twimber, by <a href="https://twitter.com/rdashinc" target='_blank'>@rdashinc</a>.</p>
            </div>
          </div>

        </div>

      </div>

    </div>
	<script>
		function auth() {
			doLoadThing("pinbutton");
			console.log("[index.html] auth(): Started.");
			var options = {
				consumerKey: window.config.consumer_key,
				consumerSecret: window.config.consumer_secret
			};
			var requestParams = location.hash.replace('#', '');
			var oauth = OAuth(options);
			var pin = document.getElementById("pin").value;
			var pwd = document.getElementById("pwd").value;
			if(typeof(pin)==='undefined') {
				window.location("load.html");
				alert("Empty Pin");
			}
			oauth.get('https://twitter.com/oauth/access_token?oauth_verifier='+pin+'&'+requestParams,

			function(data) {
				console.dir(data);
					
				// split the query string as needed						
				var accessParams = {};
				var qvars_tmp = data.text.split('&');
				for (var i = 0; i < qvars_tmp.length; i++) {
				var y = qvars_tmp[i].split('=');
					accessParams[y[0]] = decodeURIComponent(y[1]);
				}
				console.log("[index.html] auth(): Got Access Token---: "+accessParams.oauth_token);
				console.log("[index.html] auth(): Got Access Token Secret---: "+accessParams.oauth_token_secret);
				console.log("[index.html] auth(): Writing for this sessions config.");
				
				var Twit = require('twitter');
				window.config.access_token=accessParams.oauth_token;
				window.config.access_token_secret=accessParams.oauth_token_secret;
				var T = new Twit(window.config);
				
				T.get('account/verify_credentials', function(err, data, response) {
					if(err) {
						parseTwitterError(err);
					}
					if(typeof(err)!==('undefined')) {
						console.log(err);
					}
					console.log("[twitter] /auth/ => [checkCreds]: Got a response from Twitter");
					console.log(data);
					if (data.status.source == "web") {
						var source="<a href='http://twitter.com/'>web</a>"
					} else {
						var source=data.status.source
					}
					
					var config = '{ "access_token": "'+accessParams.oauth_token+'", "access_token_secret": "'+accessParams.oauth_token_secret+'", "screen_name": "'+data.screen_name+'"}';
					config = CryptoJS.AES.encrypt(config, pwd);
					
					// Write too Config.
					writeToConfig(config, "config."+data.screen_name+".js");
					writeToConfig('{ "main":"'+data.screen_name+'" }', "main.json");
					
					// Store Paswd.
					global.pwd = pwd;
					
					global.twitter_user = data.screen_name;
					
					// Init Application.
					window.location.replace("login.html#users");
				});
			},
			function(data) { alert('Failed too Log you in, Try again Later.'); console.dir("[getPin.html] (): Returned Fail: "+data); }
			);		
		}
	</script>
	<script type="text/javascript">
		function loginAsMain() {
			doLoadThing("mainLbutton");
			window.location.replace("index.html");
		}
	</script>
	<script type="text/javascript">
		function doAuthPage() {
			doLoadThing("masterbutton");
			var pwd = document.getElementById("pwd").value;
			global.pwd = pwd;
			window.location.replace("login.html#users");
		}
	</script>
  </body>
</html>